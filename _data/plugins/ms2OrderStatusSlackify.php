id: 9
source: 1
name: ms2OrderStatusSlackify
description: 'This plugin sends messages to defined channel in Slack when order status was changed.'
plugincode: "/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2015 Ivan Klimchuk\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n */\n\nswitch ($modx->event->name) {\n    case 'msOnChangeOrderStatus':\n\n        $slackify = $modx->getService('slackify');\n\n        /** @var msOrderStatus $status */\n        $status = $modx->getObject('msOrderStatus', ['id' => $order->get('status'), 'active' => true]);\n\n        $new = $order->get('status') == 1;\n\n        $a = new Attachment();\n        $a->setPretext($new ? 'New order was made on site' : 'Status of order was changed');\n        $a->setColor(new Color('#' . $status->get('color'))); // from status\n\n        $link = new Link(rtrim(MODX_SITE_URL, '/') . MODX_MANAGER_URL . \"index.php?a=mgr/orders&namespace=minishop2#&order={$order->get('id')}\", $order->get('num'));\n        $title = $new ? \"New order $link was placed on the site\" : \"Order $link was updated\";\n\n        $a->setTitle(new Title($title));\n        $a->addField(new Field('Status', $status->get('name'), true));\n        $a->addField(new Field('When', $order->get('createdon'), true));\n\n        if ($new) {\n            $a->addField(new Field('Cost', $order->get('cost'), true));\n            $a->addField(new Field('Cart cost', $order->get('cost'), true));\n\n            $a->addField(new Field('Delivery', $order->getOne('Delivery')->get('name'), true));\n            $a->addField(new Field('Delivery cost', $order->get('delivery_cost'), true));\n\n            $a->addField(new Field('Payment', $order->getOne('Payment')->get('name'), true));\n            $a->addField(new Field('Weight', $order->get('weight'), true));\n\n            $a->setText($order->get('comment'));\n        }\n\n        $message = new Message($new ? '*New order*' : '*Order status update*');\n        $message->attach($a);\n\n        $slackify->send($message);\n\n        break;\n}"
properties: null
static: 1
static_file: core/components/slackify/elements/plugins/ms2OrderStatusSlackify.php
content: "/*\n * The MIT License (MIT)\n *\n * Copyright (c) 2015 Ivan Klimchuk\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n */\n\nswitch ($modx->event->name) {\n    case 'msOnChangeOrderStatus':\n\n        $slackify = $modx->getService('slackify');\n\n        /** @var msOrderStatus $status */\n        $status = $modx->getObject('msOrderStatus', ['id' => $order->get('status'), 'active' => true]);\n\n        $new = $order->get('status') == 1;\n\n        $a = new Attachment();\n        $a->setPretext($new ? 'New order was made on site' : 'Status of order was changed');\n        $a->setColor(new Color('#' . $status->get('color'))); // from status\n\n        $link = new Link(rtrim(MODX_SITE_URL, '/') . MODX_MANAGER_URL . \"index.php?a=mgr/orders&namespace=minishop2#&order={$order->get('id')}\", $order->get('num'));\n        $title = $new ? \"New order $link was placed on the site\" : \"Order $link was updated\";\n\n        $a->setTitle(new Title($title));\n        $a->addField(new Field('Status', $status->get('name'), true));\n        $a->addField(new Field('When', $order->get('createdon'), true));\n\n        if ($new) {\n            $a->addField(new Field('Cost', $order->get('cost'), true));\n            $a->addField(new Field('Cart cost', $order->get('cost'), true));\n\n            $a->addField(new Field('Delivery', $order->getOne('Delivery')->get('name'), true));\n            $a->addField(new Field('Delivery cost', $order->get('delivery_cost'), true));\n\n            $a->addField(new Field('Payment', $order->getOne('Payment')->get('name'), true));\n            $a->addField(new Field('Weight', $order->get('weight'), true));\n\n            $a->setText($order->get('comment'));\n        }\n\n        $message = new Message($new ? '*New order*' : '*Order status update*');\n        $message->attach($a);\n\n        $slackify->send($message);\n\n        break;\n}"
